{"version":3,"sources":["../../src/utils/transactions.js"],"names":["DEFAULT_GAS_FUZZ_FACTOR","PREVIOUS_BLOCK_GAS_LIMIT_FACTOR","applyPretransaction","directTransaction","web3","token","from","to","address","tokenAddress","value","tokenValue","spender","approveSpender","erc20ABI","tokenContract","eth","Contract","balance","methods","balanceOf","call","tokenValueBN","lt","Error","allowance","allowanceBN","gt","console","warn","tokenApproveTransaction","data","approve","encodeABI","pretransaction","applyForwardingFeePretransaction","forwardingTransaction","forwarder","forwardFee","feeDetails","amount","feeResult","err","toString","createDirectTransaction","sender","destination","methodJsonDescription","params","transactionOptions","inputs","length","options","pop","abi","encodeFunctionCall","createDirectTransactionForApp","app","methodSignature","proxyAddress","fullMethodSignature","Boolean","includes","find","method","name","currentParameterTypes","Array","isArray","map","type","currentMethodSignature","join","createForwarderTransactionBuilder","forwardMethod","forwarderAddress","script","getRecommendedGasLimit","estimatedGasLimit","gasFuzzFactor","latestBlock","getBlock","latestBlockGasLimit","gasLimit","upperGasLimit","Math","round","bufferedGasLimit"],"mappings":"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","sourcesContent":["import { toBN } from 'web3-utils'\nimport { getAbi } from '../interfaces'\n\nconst DEFAULT_GAS_FUZZ_FACTOR = 1.5\nconst PREVIOUS_BLOCK_GAS_LIMIT_FACTOR = 0.95\n\nexport async function applyPretransaction (directTransaction, web3) {\n  // Token allowance pretransaction\n  if (directTransaction.token) {\n    const {\n      from,\n      to,\n      token: { address: tokenAddress, value: tokenValue, spender }\n    } = directTransaction\n\n    // Approve the transaction destination unless an spender is passed to approve a different contract\n    const approveSpender = spender || to\n\n    const erc20ABI = getAbi('standard/ERC20')\n    const tokenContract = new web3.eth.Contract(erc20ABI, tokenAddress)\n    const balance = await tokenContract.methods.balanceOf(from).call()\n\n    const tokenValueBN = toBN(tokenValue)\n\n    if (toBN(balance).lt(tokenValueBN)) {\n      throw new Error(`Balance too low. ${from} balance of ${tokenAddress} token is ${balance} (attempting to send ${tokenValue})`)\n    }\n\n    const allowance = await tokenContract.methods.allowance(from, approveSpender).call()\n    const allowanceBN = toBN(allowance)\n\n    // If allowance is already greater than or equal to amount, there is no need to do an approve transaction\n    if (allowanceBN.lt(tokenValueBN)) {\n      if (allowanceBN.gt(toBN(0))) {\n        // TODO: Actually handle existing approvals (some tokens fail when the current allowance is not 0)\n        console.warn(`${from} already approved ${approveSpender}. In some tokens, approval will fail unless the allowance is reset to 0 before re-approving again.`)\n      }\n\n      const tokenApproveTransaction = {\n        // TODO: should we include transaction options?\n        from,\n        to: tokenAddress,\n        data: tokenContract.methods.approve(approveSpender, tokenValue).encodeABI()\n      }\n\n      directTransaction.pretransaction = tokenApproveTransaction\n      delete directTransaction.token\n    }\n  }\n\n  return directTransaction\n}\n\nexport async function applyForwardingFeePretransaction (forwardingTransaction, web3) {\n  const { to: forwarder, from } = forwardingTransaction\n\n  // Check if a token approval pretransaction is needed due to the forwarder requiring a fee\n  const forwardFee = new web3.eth.Contract(\n    getAbi('aragon/ForwarderFee'),\n    forwarder\n  ).methods['forwardFee']\n\n  const feeDetails = { amount: toBN(0) }\n  try {\n    // Passing the EOA as `msg.sender` to the forwardFee call is useful for use cases where the fee differs relative to the account\n    const feeResult = await forwardFee().call({ from }) // forwardFee() returns (address, uint256)\n    feeDetails.tokenAddress = feeResult[0]\n    feeDetails.amount = toBN(feeResult[1])\n  } catch (err) {\n    // Not all forwarders implement the `forwardFee()` interface\n  }\n\n  if (feeDetails.tokenAddress && feeDetails.amount.gt(toBN(0))) {\n    // Needs a token approval pretransaction\n    forwardingTransaction.token = {\n      address: feeDetails.tokenAddress,\n      spender: forwarder, // since it's a forwarding transaction, always show the real spender\n      value: feeDetails.amount.toString()\n    }\n  }\n\n  return applyPretransaction(forwardingTransaction, web3)\n}\n\nexport async function createDirectTransaction (sender, destination, methodJsonDescription, params, web3) {\n  let transactionOptions = {}\n\n  // If an extra parameter has been provided, it is the transaction options if it is an object\n  if (methodJsonDescription.inputs.length + 1 === params.length && typeof params[params.length - 1] === 'object') {\n    const options = params.pop()\n    transactionOptions = { ...transactionOptions, ...options }\n  }\n\n  // The direct transaction we eventually want to perform\n  const directTransaction = {\n    ...transactionOptions, // Options are overwriten by the values below\n    from: sender,\n    to: destination,\n    data: web3.eth.abi.encodeFunctionCall(methodJsonDescription, params)\n  }\n\n  // Add any pretransactions specified\n  return applyPretransaction(directTransaction, web3)\n}\n\nexport async function createDirectTransactionForApp (sender, app, methodSignature, params, web3) {\n  if (!app) {\n    throw new Error(`Could not create transaction due to missing app artifact`)\n  }\n\n  const { proxyAddress: destination } = app\n\n  if (!app.abi) {\n    throw new Error(`No ABI specified in artifact for ${destination}`)\n  }\n\n  // Is the given method a full signature, e.g. 'foo(arg1,arg2,...)'\n  const fullMethodSignature =\n    Boolean(methodSignature) && methodSignature.includes('(') && methodSignature.includes(')')\n\n  const methodJsonDescription = app.abi.find(\n    (method) => {\n      // If the full signature isn't given, just find the first overload declared\n      if (!fullMethodSignature) {\n        return method.name === methodSignature\n      }\n\n      // Fallback functions don't have inputs in the ABI\n      const currentParameterTypes = Array.isArray(method.inputs) ? method.inputs.map(({ type }) => type) : []\n      const currentMethodSignature = `${method.name}(${currentParameterTypes.join(',')})`\n      return currentMethodSignature === methodSignature\n    }\n  )\n\n  if (!methodJsonDescription) {\n    throw new Error(`${methodSignature} not found on ABI for ${destination}`)\n  }\n\n  return createDirectTransaction(sender, destination, methodJsonDescription, params, web3)\n}\n\nexport function createForwarderTransactionBuilder (sender, directTransaction, web3) {\n  const forwardMethod = new web3.eth.Contract(\n    getAbi('aragon/Forwarder')\n  ).methods['forward']\n\n  return (forwarderAddress, script) => (\n    {\n      ...directTransaction, // Options are overwriten by the values below\n      from: sender,\n      to: forwarderAddress,\n      data: forwardMethod(script).encodeABI()\n    }\n  )\n}\n\nexport async function getRecommendedGasLimit (web3, estimatedGasLimit, { gasFuzzFactor = DEFAULT_GAS_FUZZ_FACTOR } = {}) {\n  const latestBlock = await web3.eth.getBlock('latest')\n  const latestBlockGasLimit = latestBlock.gasLimit\n\n  const upperGasLimit = Math.round(latestBlockGasLimit * PREVIOUS_BLOCK_GAS_LIMIT_FACTOR)\n  const bufferedGasLimit = Math.round(estimatedGasLimit * gasFuzzFactor)\n\n  if (estimatedGasLimit > upperGasLimit) {\n    // TODO: Consider whether we should throw an error rather than returning with a high gas limit\n    return estimatedGasLimit\n  } else if (bufferedGasLimit < upperGasLimit) {\n    return bufferedGasLimit\n  } else {\n    return upperGasLimit\n  }\n}\n"],"file":"transactions.js"}